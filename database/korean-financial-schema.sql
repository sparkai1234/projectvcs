-- üá∞üá∑ Korean Financial Intelligence Database Schema
-- Complete DIVA Financial Statements Structure
-- Supporting Ïû¨Î¨¥ÏÉÅÌÉúÌëú (Balance Sheet) + ÏÜêÏùµÍ≥ÑÏÇ∞ÏÑú (Income Statement)

-- ================================================================
-- Ïû¨Î¨¥ÏÉÅÌÉúÌëú (BALANCE SHEET) TABLE
-- ================================================================
CREATE TABLE IF NOT EXISTS diva_balance_sheet_raw (
    id BIGSERIAL PRIMARY KEY,
    
    -- Basic Company Information
    company_name TEXT NOT NULL,
    fiscal_year INTEGER NOT NULL,
    accounting_standard TEXT, -- K-IFRS, K-GAAP, etc.
    
    -- ÏûêÏÇ∞ (ASSETS) - Korean Won amounts
    total_assets BIGINT, -- Ï¥ùÏûêÏÇ∞
    current_assets BIGINT, -- Ïú†ÎèôÏûêÏÇ∞
    non_current_assets BIGINT, -- ÎπÑÏú†ÎèôÏûêÏÇ∞
    
    -- Ïú†ÎèôÏûêÏÇ∞ ÏÑ∏Î∂ÄÌï≠Î™© (Current Assets Details)
    cash_and_equivalents BIGINT, -- ÌòÑÍ∏àÎ∞èÌòÑÍ∏àÏÑ±ÏûêÏÇ∞
    short_term_investments BIGINT, -- Îã®Í∏∞Ìà¨ÏûêÏûêÏÇ∞
    accounts_receivable BIGINT, -- Îß§Ï∂úÏ±ÑÍ∂å
    other_current_assets BIGINT, -- Í∏∞ÌÉÄÏú†ÎèôÏûêÏÇ∞
    
    -- ÎπÑÏú†ÎèôÏûêÏÇ∞ ÏÑ∏Î∂ÄÌï≠Î™© (Non-Current Assets Details)
    venture_investment_assets BIGINT, -- Î≤§Ï≤òÌà¨ÏûêÏûêÏÇ∞ (ÌïµÏã¨)
    startup_investment_assets BIGINT, -- Ï∞ΩÏóÖÌà¨ÏûêÏûêÏÇ∞ (ÌïµÏã¨)
    venture_investment_securities BIGINT, -- Î≤§Ï≤òÌà¨ÏûêÏú†Í∞ÄÏ¶ùÍ∂å
    property_plant_equipment BIGINT, -- Ïú†ÌòïÏûêÏÇ∞
    intangible_assets BIGINT, -- Î¨¥ÌòïÏûêÏÇ∞
    other_non_current_assets BIGINT, -- Í∏∞ÌÉÄÎπÑÏú†ÎèôÏûêÏÇ∞
    
    -- Î∂ÄÏ±Ñ (LIABILITIES) - Korean Won amounts
    total_liabilities BIGINT, -- Ï¥ùÎ∂ÄÏ±Ñ
    current_liabilities BIGINT, -- Ïú†ÎèôÎ∂ÄÏ±Ñ
    non_current_liabilities BIGINT, -- ÎπÑÏú†ÎèôÎ∂ÄÏ±Ñ
    
    -- Ïú†ÎèôÎ∂ÄÏ±Ñ ÏÑ∏Î∂ÄÌï≠Î™© (Current Liabilities Details)
    accounts_payable BIGINT, -- Îß§ÏûÖÏ±ÑÎ¨¥
    short_term_borrowings BIGINT, -- Îã®Í∏∞Ï∞®ÏûÖÍ∏à
    other_current_liabilities BIGINT, -- Í∏∞ÌÉÄÏú†ÎèôÎ∂ÄÏ±Ñ
    
    -- ÎπÑÏú†ÎèôÎ∂ÄÏ±Ñ ÏÑ∏Î∂ÄÌï≠Î™© (Non-Current Liabilities Details)
    long_term_borrowings BIGINT, -- Ïû•Í∏∞Ï∞®ÏûÖÍ∏à
    bonds_payable BIGINT, -- ÏÇ¨Ï±Ñ
    other_non_current_liabilities BIGINT, -- Í∏∞ÌÉÄÎπÑÏú†ÎèôÎ∂ÄÏ±Ñ
    
    -- ÏûêÎ≥∏ (EQUITY) - Korean Won amounts
    total_equity BIGINT, -- Ï¥ùÏûêÎ≥∏
    paid_in_capital BIGINT, -- ÎÇ©ÏûÖÏûêÎ≥∏Í∏à
    capital_surplus BIGINT, -- ÏûêÎ≥∏ÏûâÏó¨Í∏à
    retained_earnings BIGINT, -- Ïù¥ÏùµÏûâÏó¨Í∏à
    other_comprehensive_income BIGINT, -- Í∏∞ÌÉÄÌè¨Í¥ÑÏÜêÏùµÎàÑÍ≥ÑÏï°
    treasury_stock BIGINT, -- ÏûêÍ∏∞Ï£ºÏãù
    
    -- Î≤§Ï≤òÏ∫êÌîºÌÉà ÌäπÌôîÌï≠Î™© (VC-Specific Items)
    fund_commitments BIGINT, -- ÌéÄÎìúÏïΩÏ†ïÏï°
    uncalled_commitments BIGINT, -- ÎØ∏ÏàòÏûÖÏïΩÏ†ïÏï°
    carried_interest BIGINT, -- ÏÑ±Í≥ºÎ≥¥Ïàò
    management_fee_receivable BIGINT, -- Ïö¥Ïö©Î≥¥ÏàòÎØ∏ÏàòÍ∏à
    
    -- Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ (Metadata)
    statement_type TEXT DEFAULT 'balance_sheet',
    statement_name TEXT DEFAULT 'Ïû¨Î¨¥ÏÉÅÌÉúÌëú',
    reporting_currency TEXT DEFAULT 'KRW',
    data_quality_score INTEGER DEFAULT 0,
    extracted_at TIMESTAMPTZ DEFAULT NOW(),
    source_url TEXT DEFAULT 'http://diva.kvca.or.kr/div/dii/DivItmFsInq',
    apify_source TEXT DEFAULT 'DIVA_SCRAPER_V2.0_ENHANCED_KOREAN_PROCESSING',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Ï†úÏïΩÏ°∞Í±¥ (Constraints)
    UNIQUE(company_name, fiscal_year, accounting_standard)
);

-- ================================================================
-- ÏÜêÏùµÍ≥ÑÏÇ∞ÏÑú (INCOME STATEMENT) TABLE  
-- ================================================================
CREATE TABLE IF NOT EXISTS diva_income_statement_raw (
    id BIGSERIAL PRIMARY KEY,
    
    -- Basic Company Information
    company_name TEXT NOT NULL,
    fiscal_year INTEGER NOT NULL,
    accounting_standard TEXT, -- K-IFRS, K-GAAP, etc.
    
    -- ÏàòÏùµ (REVENUE) - Korean Won amounts
    operating_revenue BIGINT, -- ÏòÅÏóÖÏàòÏùµ (Ï¥ùÏàòÏùµ)
    investment_income BIGINT, -- Ìà¨ÏûêÏàòÏùµ (ÌïµÏã¨)
    commission_income BIGINT, -- ÏàòÏàòÎ£åÏàòÏùµ (ÌïµÏã¨)
    management_fee_income BIGINT, -- Ïö¥Ïö©Î≥¥ÏàòÏàòÏùµ (ÌïµÏã¨)
    performance_fee_income BIGINT, -- ÏÑ±Í≥ºÎ≥¥ÏàòÏàòÏùµ (ÌïµÏã¨)
    interest_income BIGINT, -- Ïù¥ÏûêÏàòÏùµ
    dividend_income BIGINT, -- Î∞∞ÎãπÍ∏àÏàòÏùµ
    other_operating_income BIGINT, -- Í∏∞ÌÉÄÏòÅÏóÖÏàòÏùµ
    
    -- Î≤§Ï≤òÏ∫êÌîºÌÉà Ìà¨ÏûêÏàòÏùµ ÏÑ∏Î∂ÄÌï≠Î™© (VC Investment Income Details)
    realized_investment_gains BIGINT, -- Ìà¨ÏûêÏ≤òÎ∂ÑÏù¥Ïùµ (Ïã§ÌòÑÏÜêÏùµ)
    unrealized_investment_gains BIGINT, -- Ìà¨ÏûêÌèâÍ∞ÄÏù¥Ïùµ (ÎØ∏Ïã§ÌòÑÏÜêÏùµ)
    equity_method_income BIGINT, -- ÏßÄÎ∂ÑÎ≤ïÌà¨ÏûêÏù¥Ïùµ
    fair_value_gains BIGINT, -- Í≥µÏ†ïÍ∞ÄÏπòÌèâÍ∞ÄÏù¥Ïùµ
    
    -- ÎπÑÏö© (EXPENSES) - Korean Won amounts  
    operating_expenses BIGINT, -- ÏòÅÏóÖÎπÑÏö© (Ï¥ùÎπÑÏö©)
    personnel_expenses BIGINT, -- Ïù∏Í±¥ÎπÑ
    general_admin_expenses BIGINT, -- ÏùºÎ∞òÍ¥ÄÎ¶¨ÎπÑ
    commission_expenses BIGINT, -- ÏàòÏàòÎ£åÎπÑÏö©
    interest_expenses BIGINT, -- Ïù¥ÏûêÎπÑÏö©
    depreciation_expenses BIGINT, -- Í∞êÍ∞ÄÏÉÅÍ∞ÅÎπÑ
    other_operating_expenses BIGINT, -- Í∏∞ÌÉÄÏòÅÏóÖÎπÑÏö©
    
    -- Î≤§Ï≤òÏ∫êÌîºÌÉà ÎπÑÏö© ÏÑ∏Î∂ÄÌï≠Î™© (VC-Specific Expenses)
    investment_management_fees BIGINT, -- Ìà¨ÏûêÍ¥ÄÎ¶¨ÏàòÏàòÎ£å
    fund_administration_fees BIGINT, -- ÌéÄÎìúÍ¥ÄÎ¶¨ÎπÑÏö©
    due_diligence_expenses BIGINT, -- Ïã§ÏÇ¨ÎπÑÏö©
    legal_advisory_fees BIGINT, -- Î≤ïÎ¨¥ÏûêÎ¨∏ÎπÑ
    
    -- ÏÜêÏùµ Ìï≠Î™© (PROFIT/LOSS ITEMS) - Korean Won amounts
    gross_profit BIGINT, -- Ï¥ùÏù¥Ïùµ
    operating_profit BIGINT, -- ÏòÅÏóÖÏù¥Ïùµ
    net_income_before_tax BIGINT, -- ÏÑ∏Ï†ÑÏàúÏù¥Ïùµ
    income_tax_expense BIGINT, -- Î≤ïÏù∏ÏÑ∏ÎπÑÏö©
    net_income BIGINT, -- ÎãπÍ∏∞ÏàúÏù¥Ïùµ
    
    -- Í∏∞ÌÉÄ ÏÜêÏùµÌï≠Î™© (Other Income/Loss Items)
    extraordinary_gains BIGINT, -- ÌäπÎ≥ÑÏù¥Ïùµ
    extraordinary_losses BIGINT, -- ÌäπÎ≥ÑÏÜêÏã§
    foreign_exchange_gains BIGINT, -- Ïô∏ÌôòÏ∞®Ïùµ
    foreign_exchange_losses BIGINT, -- Ïô∏ÌôòÏ∞®ÏÜê
    
    -- Ï£ºÎãπ Ï†ïÎ≥¥ (Per Share Information)
    earnings_per_share DECIMAL(15,2), -- Ï£ºÎãπÏàúÏù¥Ïùµ
    diluted_earnings_per_share DECIMAL(15,2), -- Ìù¨ÏÑùÏ£ºÎãπÏàúÏù¥Ïùµ
    
    -- Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ (Metadata)
    statement_type TEXT DEFAULT 'income_statement',
    statement_name TEXT DEFAULT 'ÏÜêÏùµÍ≥ÑÏÇ∞ÏÑú',
    reporting_currency TEXT DEFAULT 'KRW',
    data_quality_score INTEGER DEFAULT 0,
    extracted_at TIMESTAMPTZ DEFAULT NOW(),
    source_url TEXT DEFAULT 'http://diva.kvca.or.kr/div/dii/DivItmFsInq',
    apify_source TEXT DEFAULT 'DIVA_SCRAPER_V2.0_ENHANCED_KOREAN_PROCESSING',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Ï†úÏïΩÏ°∞Í±¥ (Constraints)
    UNIQUE(company_name, fiscal_year, accounting_standard)
);

-- ================================================================
-- ÌÜµÌï© Ïû¨Î¨¥Ï†úÌëú Î∑∞ (COMBINED FINANCIAL STATEMENTS VIEW)
-- ================================================================
CREATE OR REPLACE VIEW diva_financial_statements_combined AS
SELECT 
    COALESCE(bs.company_name, is_table.company_name) as company_name,
    COALESCE(bs.fiscal_year, is_table.fiscal_year) as fiscal_year,
    COALESCE(bs.accounting_standard, is_table.accounting_standard) as accounting_standard,
    
    -- Balance Sheet Items
    bs.total_assets,
    bs.total_liabilities,
    bs.total_equity,
    bs.venture_investment_assets,
    bs.startup_investment_assets,
    bs.paid_in_capital,
    bs.retained_earnings,
    
    -- Income Statement Items
    is_table.operating_revenue,
    is_table.investment_income,
    is_table.commission_income,
    is_table.management_fee_income,
    is_table.operating_profit,
    is_table.net_income,
    is_table.realized_investment_gains,
    is_table.unrealized_investment_gains,
    
    -- Financial Ratios (Calculated)
    CASE 
        WHEN bs.total_assets > 0 THEN ROUND((is_table.net_income::DECIMAL / bs.total_assets) * 100, 2)
        ELSE NULL 
    END as roa_percent, -- Ï¥ùÏûêÏÇ∞ÏàòÏùµÎ•†
    
    CASE 
        WHEN bs.total_equity > 0 THEN ROUND((is_table.net_income::DECIMAL / bs.total_equity) * 100, 2)
        ELSE NULL 
    END as roe_percent, -- ÏûêÍ∏∞ÏûêÎ≥∏ÏàòÏùµÎ•†
    
    CASE 
        WHEN bs.total_assets > 0 THEN ROUND((bs.total_liabilities::DECIMAL / bs.total_assets) * 100, 2)
        ELSE NULL 
    END as debt_ratio_percent, -- Î∂ÄÏ±ÑÎπÑÏú®
    
    -- Metadata
    GREATEST(bs.extracted_at, is_table.extracted_at) as last_updated,
    bs.created_at as balance_sheet_created,
    is_table.created_at as income_statement_created
    
FROM diva_balance_sheet_raw bs
FULL OUTER JOIN diva_income_statement_raw is_table 
    ON bs.company_name = is_table.company_name 
    AND bs.fiscal_year = is_table.fiscal_year
    AND bs.accounting_standard = is_table.accounting_standard;

-- ================================================================
-- Ïù∏Îç±Ïä§ (INDEXES) for Performance
-- ================================================================

-- Balance Sheet Indexes
CREATE INDEX IF NOT EXISTS idx_balance_sheet_company_year 
    ON diva_balance_sheet_raw(company_name, fiscal_year);
    
CREATE INDEX IF NOT EXISTS idx_balance_sheet_extracted_at 
    ON diva_balance_sheet_raw(extracted_at);
    
CREATE INDEX IF NOT EXISTS idx_balance_sheet_total_assets 
    ON diva_balance_sheet_raw(total_assets DESC) WHERE total_assets IS NOT NULL;

-- Income Statement Indexes  
CREATE INDEX IF NOT EXISTS idx_income_statement_company_year 
    ON diva_income_statement_raw(company_name, fiscal_year);
    
CREATE INDEX IF NOT EXISTS idx_income_statement_extracted_at 
    ON diva_income_statement_raw(extracted_at);
    
CREATE INDEX IF NOT EXISTS idx_income_statement_net_income 
    ON diva_income_statement_raw(net_income DESC) WHERE net_income IS NOT NULL;

-- ================================================================
-- RLS (Row Level Security) Ï†ïÏ±Ö
-- ================================================================

-- Enable RLS
ALTER TABLE diva_balance_sheet_raw ENABLE ROW LEVEL SECURITY;
ALTER TABLE diva_income_statement_raw ENABLE ROW LEVEL SECURITY;

-- Create policies for service role (for Apify scraper)
CREATE POLICY "Allow service role full access to balance sheet" 
    ON diva_balance_sheet_raw FOR ALL 
    TO service_role USING (true);

CREATE POLICY "Allow service role full access to income statement" 
    ON diva_income_statement_raw FOR ALL 
    TO service_role USING (true);

-- Create policies for authenticated users (read-only)
CREATE POLICY "Allow authenticated read access to balance sheet" 
    ON diva_balance_sheet_raw FOR SELECT 
    TO authenticated USING (true);

CREATE POLICY "Allow authenticated read access to income statement" 
    ON diva_income_statement_raw FOR SELECT 
    TO authenticated USING (true);

-- ================================================================
-- ÌÖåÏù¥Î∏î ÏΩîÎ©òÌä∏ (Table Comments)
-- ================================================================

COMMENT ON TABLE diva_balance_sheet_raw IS 
'Korean Venture Capital Balance Sheets (Ïû¨Î¨¥ÏÉÅÌÉúÌëú) from DIVA portal with K-IFRS compliance';

COMMENT ON TABLE diva_income_statement_raw IS 
'Korean Venture Capital Income Statements (ÏÜêÏùµÍ≥ÑÏÇ∞ÏÑú) from DIVA portal with VC-specific metrics';

COMMENT ON VIEW diva_financial_statements_combined IS 
'Combined view of Balance Sheet and Income Statement with calculated financial ratios';

-- ================================================================
-- ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå ÏøºÎ¶¨ (Sample Queries)
-- ================================================================

-- Top Korean VCs by Total Assets
-- SELECT company_name, fiscal_year, total_assets, venture_investment_assets 
-- FROM diva_balance_sheet_raw 
-- WHERE total_assets IS NOT NULL 
-- ORDER BY total_assets DESC LIMIT 10;

-- Top Korean VCs by Investment Income
-- SELECT company_name, fiscal_year, investment_income, realized_investment_gains 
-- FROM diva_income_statement_raw 
-- WHERE investment_income IS NOT NULL 
-- ORDER BY investment_income DESC LIMIT 10;

-- Combined Financial Health Overview
-- SELECT company_name, fiscal_year, total_assets, net_income, roa_percent, roe_percent
-- FROM diva_financial_statements_combined 
-- WHERE total_assets > 0 AND net_income IS NOT NULL
-- ORDER BY total_assets DESC LIMIT 10; 